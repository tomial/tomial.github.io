<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>goroutine控制：WaitGroup解析 - Tomial's Blog</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:image" content><meta property="og:title" content="goroutine控制：WaitGroup解析"><meta property="og:description" content="WaitGroup是Go经常使用的并发控制工具，它非常适合等待一组goroutine结束的场景"><meta property="og:type" content="article"><meta property="og:url" content="https://tomial.github.io/posts/goroutine/waitgroup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-29T17:14:53+08:00"><meta property="article:modified_time" content="2024-02-29T17:14:53+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="goroutine控制：WaitGroup解析"><meta name=twitter:description content="WaitGroup是Go经常使用的并发控制工具，它非常适合等待一组goroutine结束的场景"><script src=https://tomial.github.io/js/feather.min.js></script><link href=https://tomial.github.io/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://tomial.github.io/css/main.css><link rel=stylesheet type=text/css href=https://tomial.github.io/css/dark.css></head><body><div class=content><header><div class=main><a href=https://tomial.github.io/>Tomial's Blog</a></div><nav><a href=/>主页</a>
<a href=/posts>全部文章</a>
<a href=/tags>标签</a>
<a href=/about>关于</a></nav></header><main><article><div class=title><h1 class=title>goroutine控制：WaitGroup解析</h1><div class=meta style=margin-bottom:3em>最后编辑于 2024-02-29</div></div><section class=body><p>WaitGroup是Go经常使用的并发控制工具，它非常适合等待一组goroutine结束的场景</p><p>wg的使用方法非常简单，主要的API只有<code>Add()</code>，<code>Wait()</code>和<code>Done()</code></p><p>在下面的例子中，主goroutine等待两个子goroutine结束后才返回：</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#94e2d5>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#94e2d5>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e3a1>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e3a1>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e3a1>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#f38ba8>var</span> wg sync.WaitGroup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 代表等待2个goroutine结束
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	wg.<span style=color:#89b4fa>Add</span>(<span style=color:#fab387>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cba6f7>go</span> <span style=color:#f38ba8>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#6c7086;font-style:italic>// Do something
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>		time.<span style=color:#89b4fa>Sleep</span>(time.Second)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		fmt.<span style=color:#89b4fa>Println</span>(<span style=color:#a6e3a1>&#34;Goroutine 1 finished!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6c7086;font-style:italic>// 通知WaitGroup本goroutine已完成
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>		wg.<span style=color:#89b4fa>Done</span>()
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cba6f7>go</span> <span style=color:#f38ba8>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#6c7086;font-style:italic>// Do something
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>		time.<span style=color:#89b4fa>Sleep</span>(time.Second)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		fmt.<span style=color:#89b4fa>Println</span>(<span style=color:#a6e3a1>&#34;Goroutine 2 finished!&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#6c7086;font-style:italic>// 通知WaitGroup本goroutine已完成
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>		wg.<span style=color:#89b4fa>Done</span>()
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 阻塞当前goroutine，所有等待的子goroutine完成后才返回
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	wg.<span style=color:#89b4fa>Wait</span>()
</span></span><span style=display:flex><span>	fmt.<span style=color:#89b4fa>Println</span>(<span style=color:#a6e3a1>&#34;All Goroutines finished&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>运行结果：</p><pre tabindex=0><code>// 完成顺序不一定相同
Goroutine 2 finished!
Goroutine 1 finished!
All Goroutines finished
</code></pre><p>WaitGroup的实现非常简单，主要是两个计数器和一个信号量（Semaphore）：</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f38ba8>type</span> WaitGroup <span style=color:#f38ba8>struct</span> {
</span></span><span style=display:flex><span>	noCopy noCopy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 高32位是等待（调用Add的）计数器，低32位是父协程（调用Wait的）数量
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#6c7086;font-style:italic>// count 和 wait count
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	state1 <span style=color:#f38ba8>uint64</span>
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 信号量指针
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	state2 <span style=color:#f38ba8>uint32</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>//通过state()获取上面的值
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span><span style=color:#f38ba8>func</span> (wg <span style=color:#89dceb;font-weight:700>*</span>WaitGroup) <span style=color:#89b4fa>state</span>() (statep <span style=color:#89dceb;font-weight:700>*</span><span style=color:#f38ba8>uint64</span>, semap <span style=color:#89dceb;font-weight:700>*</span><span style=color:#f38ba8>uint32</span>) {
</span></span><span style=display:flex><span>	<span style=color:#cba6f7>if</span> unsafe.<span style=color:#89b4fa>Alignof</span>(wg.state1) <span style=color:#89dceb;font-weight:700>==</span> <span style=color:#fab387>8</span> <span style=color:#89dceb;font-weight:700>||</span> <span style=color:#89dceb>uintptr</span>(unsafe.<span style=color:#89b4fa>Pointer</span>(<span style=color:#89dceb;font-weight:700>&amp;</span>wg.state1))<span style=color:#89dceb;font-weight:700>%</span><span style=color:#fab387>8</span> <span style=color:#89dceb;font-weight:700>==</span> <span style=color:#fab387>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#cba6f7>return</span> <span style=color:#89dceb;font-weight:700>&amp;</span>wg.state1, <span style=color:#89dceb;font-weight:700>&amp;</span>wg.state2
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#89dceb;font-weight:700>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>信号量是常见的类UNIX操作系统提供的保护线程间共享资源的工具，主要分为<code>P</code>, <code>V</code>两个操作，以下简称<code>semap</code></p><blockquote><p>信号量由Dijkstra提出，由于他是荷兰人，所以PV是荷兰语的缩写：</p><p>V stands for &lsquo;Verhoog&rsquo;, which can be translated as &ldquo;increment&rdquo;.</p><p>P stands for &lsquo;Prolaag&rsquo;, a madeup Dutch word of &lsquo;probeer verlaag&rsquo;, which can be translated as &ldquo;try to decrease&rdquo;.</p><p>See the naming in the <a href=https://cs.nyu.edu/%7Eyap/classes/os/resources/EWD74.pdf>original paper</a>.</p></blockquote><p>即<code>V</code>代表增加，<code>P</code>代表尝试减少</p><ul><li>semap = 0时，资源不可用，在此时获取资源线程会进入睡眠，在有资源可用时再唤醒线程</li><li>semap > 0时，资源可用，此时获取资源会将信号量减一</li></ul><p>值得注意的是，<code>Done()</code>实际上就是<code>Add(-1)</code>。</p><p>WaitGroup使用信号量实现了父子协程的唤醒功能，简单来说，父协程先调用<code>Add(n)</code>指示需要等待多少个子协程完成，之后创建对应数量的子协程后调用<code>Wait()</code>等待子协程完成：</p><ul><li>当子协程还在运行时，<code>Wait()</code>会让父协程阻塞在获取资源那一步。</li><li>当所有子协程完成后，最后一个子协程会调用<code>Done()</code>，即<code>Add(-1)</code>。在<code>Add()</code>的实现中，当所有子协程已完成时，会释放对应调用<code>Wait()</code>的数量的资源，即让所有<code>Wait()</code>的父协程继续运行，父协程此时就能从<code>Wait()</code>返回并继续运行。</li></ul><p>以下是节选的实现代码：</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">90
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f38ba8>func</span> (wg <span style=color:#89dceb;font-weight:700>*</span>WaitGroup) <span style=color:#89b4fa>Add</span>(delta <span style=color:#f38ba8>int</span>) {
</span></span><span style=display:flex><span>	statep, semap <span style=color:#89dceb;font-weight:700>:=</span> wg.<span style=color:#89b4fa>state</span>()
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 下面的if是竞争状态检测
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#cba6f7>if</span> race.Enabled {
</span></span><span style=display:flex><span>		_ = <span style=color:#89dceb;font-weight:700>*</span>statep
</span></span><span style=display:flex><span>		<span style=color:#cba6f7>if</span> delta &lt; <span style=color:#fab387>0</span> {
</span></span><span style=display:flex><span>			race.<span style=color:#89b4fa>ReleaseMerge</span>(unsafe.<span style=color:#89b4fa>Pointer</span>(wg))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		race.<span style=color:#89b4fa>Disable</span>()
</span></span><span style=display:flex><span>		<span style=color:#cba6f7>defer</span> race.<span style=color:#89b4fa>Enable</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	state <span style=color:#89dceb;font-weight:700>:=</span> atomic.<span style=color:#89b4fa>AddUint64</span>(statep, <span style=color:#89dceb>uint64</span>(delta)<span style=color:#89dceb;font-weight:700>&lt;&lt;</span><span style=color:#fab387>32</span>) <span style=color:#6c7086;font-style:italic>// 增加等待数量
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	v <span style=color:#89dceb;font-weight:700>:=</span> <span style=color:#89dceb>int32</span>(state <span style=color:#89dceb;font-weight:700>&gt;&gt;</span> <span style=color:#fab387>32</span>) <span style=color:#6c7086;font-style:italic>// 等待的子协程数
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	w <span style=color:#89dceb;font-weight:700>:=</span> <span style=color:#89dceb>uint32</span>(state)      <span style=color:#6c7086;font-style:italic>// 阻塞的父协程数
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 一些错误检测
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#cba6f7>if</span> race.Enabled <span style=color:#89dceb;font-weight:700>&amp;&amp;</span> delta &gt; <span style=color:#fab387>0</span> <span style=color:#89dceb;font-weight:700>&amp;&amp;</span> v <span style=color:#89dceb;font-weight:700>==</span> <span style=color:#89dceb>int32</span>(delta) {
</span></span><span style=display:flex><span>		race.<span style=color:#89b4fa>Read</span>(unsafe.<span style=color:#89b4fa>Pointer</span>(semap))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#cba6f7>if</span> v &lt; <span style=color:#fab387>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#89dceb>panic</span>(<span style=color:#a6e3a1>&#34;sync: negative WaitGroup counter&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#cba6f7>if</span> w <span style=color:#89dceb;font-weight:700>!=</span> <span style=color:#fab387>0</span> <span style=color:#89dceb;font-weight:700>&amp;&amp;</span> delta &gt; <span style=color:#fab387>0</span> <span style=color:#89dceb;font-weight:700>&amp;&amp;</span> v <span style=color:#89dceb;font-weight:700>==</span> <span style=color:#89dceb>int32</span>(delta) {
</span></span><span style=display:flex><span>		<span style=color:#89dceb>panic</span>(<span style=color:#a6e3a1>&#34;sync: WaitGroup misuse: Add called concurrently with Wait&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 当还有子协程在运行或没有父协程需要唤醒时直接返回
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#cba6f7>if</span> v &gt; <span style=color:#fab387>0</span> <span style=color:#89dceb;font-weight:700>||</span> w <span style=color:#89dceb;font-weight:700>==</span> <span style=color:#fab387>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#cba6f7>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 跑到这里的时候v必定等于0且有需要唤醒的父协程，即所有子协程已经运行完毕，需要唤醒父协程继续运行
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#6c7086;font-style:italic>// 错误检测
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#cba6f7>if</span> <span style=color:#89dceb;font-weight:700>*</span>statep <span style=color:#89dceb;font-weight:700>!=</span> state {
</span></span><span style=display:flex><span>		<span style=color:#89dceb>panic</span>(<span style=color:#a6e3a1>&#34;sync: WaitGroup misuse: Add called concurrently with Wait&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 初始化count和wait count
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#89dceb;font-weight:700>*</span>statep = <span style=color:#fab387>0</span>
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 唤醒所有父协程
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#cba6f7>for</span> ; w <span style=color:#89dceb;font-weight:700>!=</span> <span style=color:#fab387>0</span>; w<span style=color:#89dceb;font-weight:700>--</span> {
</span></span><span style=display:flex><span>		<span style=color:#89b4fa>runtime_Semrelease</span>(semap, <span style=color:#fab387>false</span>, <span style=color:#fab387>0</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>func</span> (wg <span style=color:#89dceb;font-weight:700>*</span>WaitGroup) <span style=color:#89b4fa>Done</span>() {
</span></span><span style=display:flex><span>	wg.<span style=color:#89b4fa>Add</span>(<span style=color:#89dceb;font-weight:700>-</span><span style=color:#fab387>1</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>func</span> (wg <span style=color:#89dceb;font-weight:700>*</span>WaitGroup) <span style=color:#89b4fa>Wait</span>() {
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 获取数量和信号量指针
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	statep, semap <span style=color:#89dceb;font-weight:700>:=</span> wg.<span style=color:#89b4fa>state</span>()
</span></span><span style=display:flex><span>	<span style=color:#6c7086;font-style:italic>// 竞争状态检测
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>	<span style=color:#cba6f7>if</span> race.Enabled {
</span></span><span style=display:flex><span>		_ = <span style=color:#89dceb;font-weight:700>*</span>statep <span style=color:#6c7086;font-style:italic>// trigger nil deref early
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>		race.<span style=color:#89b4fa>Disable</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#cba6f7>for</span> {
</span></span><span style=display:flex><span>		state <span style=color:#89dceb;font-weight:700>:=</span> atomic.<span style=color:#89b4fa>LoadUint64</span>(statep)
</span></span><span style=display:flex><span>		v <span style=color:#89dceb;font-weight:700>:=</span> <span style=color:#89dceb>int32</span>(state <span style=color:#89dceb;font-weight:700>&gt;&gt;</span> <span style=color:#fab387>32</span>)
</span></span><span style=display:flex><span>		w <span style=color:#89dceb;font-weight:700>:=</span> <span style=color:#89dceb>uint32</span>(state)
</span></span><span style=display:flex><span>		<span style=color:#6c7086;font-style:italic>// 如果没有需要等待的子协程，直接返回
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>		<span style=color:#cba6f7>if</span> v <span style=color:#89dceb;font-weight:700>==</span> <span style=color:#fab387>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#cba6f7>if</span> race.Enabled {
</span></span><span style=display:flex><span>				race.<span style=color:#89b4fa>Enable</span>()
</span></span><span style=display:flex><span>				race.<span style=color:#89b4fa>Acquire</span>(unsafe.<span style=color:#89b4fa>Pointer</span>(wg))
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#cba6f7>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#6c7086;font-style:italic>// 增加父协程数量
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>		<span style=color:#cba6f7>if</span> atomic.<span style=color:#89b4fa>CompareAndSwapUint64</span>(statep, state, state<span style=color:#89dceb;font-weight:700>+</span><span style=color:#fab387>1</span>) {
</span></span><span style=display:flex><span>			<span style=color:#6c7086;font-style:italic>// 竞争状态检测
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>			<span style=color:#cba6f7>if</span> race.Enabled <span style=color:#89dceb;font-weight:700>&amp;&amp;</span> w <span style=color:#89dceb;font-weight:700>==</span> <span style=color:#fab387>0</span> {
</span></span><span style=display:flex><span>				race.<span style=color:#89b4fa>Write</span>(unsafe.<span style=color:#89b4fa>Pointer</span>(semap))
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#6c7086;font-style:italic>// 阻塞，等待子协程结束并获取资源
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>			<span style=color:#89b4fa>runtime_Semacquire</span>(semap)
</span></span><span style=display:flex><span>			<span style=color:#cba6f7>if</span> <span style=color:#89dceb;font-weight:700>*</span>statep <span style=color:#89dceb;font-weight:700>!=</span> <span style=color:#fab387>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#89dceb>panic</span>(<span style=color:#a6e3a1>&#34;sync: WaitGroup is reused before previous Wait has returned&#34;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#cba6f7>if</span> race.Enabled {
</span></span><span style=display:flex><span>				race.<span style=color:#89b4fa>Enable</span>()
</span></span><span style=display:flex><span>				race.<span style=color:#89b4fa>Acquire</span>(unsafe.<span style=color:#89b4fa>Pointer</span>(wg))
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#6c7086;font-style:italic>// 获取资源后返回
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>			<span style=color:#cba6f7>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>以下是一些WaitGroup的注意事项：</p><ul><li>A WaitGroup must not be copied after first use.</li><li>Add must happen before a Wait. Calls with a negative delta, or calls with a positive delta that start when the counter is greater than zero, may happen at any time.</li><li>New Add calls must happen after all previous Wait calls have returned.</li><li>Adds must not happen concurrently with Wait</li></ul><p>参考资料：</p><ul><li><a href=https://stackoverflow.com/questions/29606162/what-is-the-original-meaning-of-p-and-v-operations-in-a-context-of-a-semaphore>What is the original meaning of P and V operations in a context of a semaphore?</a></li></ul></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/go>go</a></li></ul></nav></div></article></main><footer><hr><a class=soc href=https://github.com/tomial title=Github><i data-feather=github></i></a>|⚡️
2024 © Tomial | Modified <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script>feather.replace()</script></div></body></html>