<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Rack - Tomial's Blog</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:image" content><meta property="og:url" content="https://tomial.github.io/posts/rack/"><meta property="og:site_name" content="Tomial's Blog"><meta property="og:title" content="Rack"><meta property="og:description" content="Rack既是一个规范，也是一个实现这个规范的Ruby库。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-26T14:47:13+08:00"><meta property="article:modified_time" content="2024-12-26T14:47:13+08:00"><meta property="article:tag" content="Rack"><meta property="article:tag" content="Ruby"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rack"><meta name=twitter:description content="Rack既是一个规范，也是一个实现这个规范的Ruby库。"><script src=https://tomial.github.io/js/feather.min.js></script><link href=https://tomial.github.io/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://tomial.github.io/css/main.css><link rel=stylesheet type=text/css href=https://tomial.github.io/css/dark.css></head><body><div class=content><header><div class=main><a href=https://tomial.github.io/>Tomial's Blog</a></div><nav><a href=/>主页</a>
<a href=/posts>全部文章</a>
<a href=/tags>标签</a>
<a href=/about>关于</a></nav></header><main><article><div class=title><h1 class=title>Rack</h1><div class=meta style=margin-bottom:3em>最后编辑于 2024-12-26</div></div><section class=body><p>Rack既是一个规范，也是一个实现这个规范的Ruby库。</p><p>Rack充当了App Server（Unicorn，Puma等）和Web App(Rails，Sinatra)之间的桥梁。
符合Rack App规范的App Server和Web App可以轻松组合在一起。</p><h2 id=rack定义>Rack定义</h2><p>Rack App的定义为：</p><blockquote><p>A Rack application is a Ruby object (not a class) that responds to call. It takes exactly one argument, the environment and returns a non-frozen Array of exactly three values: The status, the headers, and the body.</p></blockquote><p>一个Rack App是一个响应call方法的Ruby对象（而不是类）。它只接受一个参数，即环境参数，并且返回一个包含<strong>HTTP状态码，头部，body</strong>的non-frozen数组</p><p>一个简单的Rack App：</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#cba6f7>class</span> <span style=color:#f9e2af>HelloWorld</span>
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>def</span> <span style=color:#89b4fa>call</span>(env)                                    <span style=color:#6c7086;font-style:italic># 环境参数</span>
</span></span><span style=display:flex><span>    <span style=color:#89dceb;font-weight:700>[</span>
</span></span><span style=display:flex><span>      <span style=color:#fab387>200</span>,                                         <span style=color:#6c7086;font-style:italic># 状态码</span>
</span></span><span style=display:flex><span>      {<span style=color:#a6e3a1>&#39;Content-Type&#39;</span> <span style=color:#89dceb;font-weight:700>=&gt;</span> <span style=color:#a6e3a1>&#39;text/plain&#39;</span>},            <span style=color:#6c7086;font-style:italic># 响应头</span>
</span></span><span style=display:flex><span>      <span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>&#39;Hello World&#39;</span><span style=color:#89dceb;font-weight:700>]</span>                              <span style=color:#6c7086;font-style:italic># 响应体</span>
</span></span><span style=display:flex><span>    <span style=color:#89dceb;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>end</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>end</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=环境参数的定义the-environment>环境参数的定义（The Environment）</h2><blockquote><p>The environment must be an unfrozen instance of Hash that includes CGI-like headers. The Rack application is free to modify the environment.</p></blockquote><p>环境参数必须是一个Hash，它包含了一系列CGI风格头部，Rack App可以随意修改这个环境参数。
这里的CGI风格指的传统的CGI接口命名：</p><ul><li>使用 <code>大写字母 + 下划线</code> 的命名方式，比如 <code>HTTP_HOST</code>、<code>HTTP_USER_AGENT</code>。</li><li>以 <code>HTTP_</code> 开头的变量表示 HTTP 请求头。例如：<ul><li>HTTP 请求头 <code>Host: example.com</code> 会映射为 <code>HTTP_HOST</code>。</li><li>HTTP 请求头 <code>User-Agent: curl/7.68.0</code> 会映射为 <code>HTTP_USER_AGENT</code>。</li></ul></li></ul><p>例如：</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>env <span style=color:#89dceb;font-weight:700>=</span> {} <span style=color:#f38ba8>✅</span>
</span></span><span style=display:flex><span>env <span style=color:#89dceb;font-weight:700>=</span> { <span style=color:#a6e3a1>HTTP_HOST</span>: <span style=color:#a6e3a1>&#39;test.com&#39;</span>,  <span style=color:#a6e3a1>HTTP_USER_AGENT</span>: <span style=color:#a6e3a1>&#39;curl/7.68.0&#39;</span> } <span style=color:#f38ba8>✅</span>
</span></span><span style=display:flex><span>env <span style=color:#89dceb;font-weight:700>=</span> { <span style=color:#a6e3a1>host</span>: <span style=color:#a6e3a1>&#39;test.com&#39;</span>,  <span style=color:#a6e3a1>user_agent</span>: <span style=color:#a6e3a1>&#39;curl/7.68.0&#39;</span> } <span style=color:#f38ba8>❌</span>
</span></span></code></pre></td></tr></table></div></div><p>规范里规定了一些除空值情况外<a href=https://github.com/rack/rack/blob/main/SPEC.rdoc#label-The+Environment>必须包含的环境参数</a></p><p>Web Server和Web App也可以在环境参数里保存自己的数据，需要注意的是，参数key必须包含一个<code>.</code>，并且具有唯一的前缀。<code>rack.</code>前缀是为rack库保留的，不能随意使用</p><h2 id=the-input-stream>The Input Stream</h2><blockquote><p>The input stream is an IO-like object which contains the raw HTTP POST data.</p></blockquote><p>环境参数中的<code>rack.input</code>存储了POST请求的原始数据，当可用时，它必须以<code>ASCII 8bit</code>二进制编码的格式被打开，并且能响应<code>gets</code>, <code>each</code>, <code>read</code>方法</p><p><code>rack.errors</code>与<code>rack.input</code>类似，用于记录/响应错误。</p><h2 id=响应>响应</h2><h3 id=状态码>状态码</h3><p>必须是大于等于100的整数HTTP状态码</p><h3 id=头部>头部</h3><blockquote><p>The headers must be a unfrozen Hash. The header keys must be Strings.</p></blockquote><h3 id=body>Body</h3><blockquote><p>The Body is typically an <code>Array</code> of <code>String</code> instances, an <code>enumerable</code> that yields <code>String</code> instances, a <code>Proc</code> instance, or a <code>File-like object</code>.</p></blockquote><p>关于环境参数及响应的具体要求可以参考Rack SPEC。</p><h3 id=rack的用途>Rack的用途</h3><p>那么有了Rack能做什么呢？Rack充当了Ruby App Server和Ruby Web框架两者的胶水，实现关注点分离，开发者可以随时替换任一部分，例如Rails可以使用Unicorn，也可以使用Puma作为App Server，后续有更新的Server或Web框架都可以使用。之所以可以实现这点，就是因为Unicorn，Puma，Rails都是遵循Rack规范的。</p><p>每个Rack App都由Handler来调用（一般是Puma这种App Server提供），即由handler提供给我们编写的Rack App上下文（Web请求），由我们编写的Rack App来处理该请求。</p><p>最极简的流程就是Puma(Handler)获取到了HTTP请求，把请求交给Rack App处理（Handler调用Rack App的call），Puma(Handler)获取返回结果后响应给用户浏览器。下面的例子就展示了这样的流程。</p><h3 id=一个简单的rack-app例子>一个简单的Rack App例子</h3><p><strong><code>code.rb</code></strong></p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#89dceb>require</span> <span style=color:#a6e3a1>&#39;rack&#39;</span>
</span></span><span style=display:flex><span><span style=color:#89dceb>require</span> <span style=color:#a6e3a1>&#39;rack/handler/puma&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># 一个简单的 Rack 应用</span>
</span></span><span style=display:flex><span>app <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#f9e2af>Proc</span><span style=color:#89dceb;font-weight:700>.</span>new <span style=color:#cba6f7>do</span> <span style=color:#89dceb;font-weight:700>|</span>env<span style=color:#89dceb;font-weight:700>|</span>
</span></span><span style=display:flex><span>  <span style=color:#6c7086;font-style:italic># 返回 HTTP 200状态码，头部为Content-Type，Body为&#34;Hello, Puma!&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#89dceb;font-weight:700>[</span><span style=color:#fab387>200</span>, { <span style=color:#a6e3a1>&#39;Content-Type&#39;</span> <span style=color:#89dceb;font-weight:700>=&gt;</span> <span style=color:#a6e3a1>&#39;text/plain&#39;</span> }, <span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>&#34;Hello, Puma!&#34;</span><span style=color:#89dceb;font-weight:700>]]</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># 由puma的Rack Handler运行上述 Rack 应用</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># run的内部会调用app.call(env)</span>
</span></span><span style=display:flex><span><span style=color:#f9e2af>Rack</span><span style=color:#89dceb;font-weight:700>::</span><span style=color:#f9e2af>Handler</span><span style=color:#89dceb;font-weight:700>::</span><span style=color:#f9e2af>Puma</span><span style=color:#89dceb;font-weight:700>.</span>run app
</span></span></code></pre></td></tr></table></div></div><p>运行上述代码：<code>ruby code.rb</code>：</p><p><img src=/images/rack/rack-app-shell-prompt.jpg alt="运行rack app"></p><p><img src=/images/rack/simple-rack-app.jpg alt="运行rack app浏览器显示"></p><p>一个简单的Web App就完成了，Rails和Sinatra这类Web框架都是基于Rack的扩展，Rack的设计对于中间件编写也同样方便，而且符合Rack规范的中间件可以在不同的Web框架中使用。</p><p>Rack除了是一个规范，还实现了一个Rack库，提供了一系列方便编写及运行Rack App的工具，包括一些简单的App Server（WEBrick,Thin等）、中间件和命令行工具<code>rackup</code>等。</p><p>参考资料：</p><ul><li><a href=https://github.com/rack/rack/blob/main/SPEC.rdoc>Rack SPEC</a></li><li><a href=https://web.archive.org/web/20200225220612/http://rubylearning.com/blog/2013/04/02/whats-rack/>What's Rack</a></li></ul></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/rack>Rack</a></li><li><a href=/tags/ruby>Ruby</a></li></ul></nav></div></article></main><footer><hr><a class=soc href=https://github.com/tomial title=Github><i data-feather=github></i></a>|⚡️
2024 © Tomial | Modified <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script>feather.replace()</script></div></body></html>